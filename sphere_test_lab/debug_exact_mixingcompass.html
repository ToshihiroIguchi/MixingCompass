<!DOCTYPE html>
<html>
<head>
    <title>Exact MixingCompass Debug</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .test-box { border: 1px solid #ccc; padding: 15px; }
        .plot-container { width: 100%; height: 500px; margin: 10px 0; }
        .analysis { background: #f0f0f0; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a87; }
        .highlight { background: yellow; font-weight: bold; }
        .difference { background: #ffcccc; padding: 5px; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exact MixingCompass Configuration Debug</h1>

        <div class="controls">
            <button onclick="testCurrentMixingCompass()">Test Current MixingCompass Settings</button>
            <button onclick="testAllVariations()">Test All Layout Variations</button>
            <button onclick="inspectPlotlySettings()">Inspect Plotly Settings</button>
        </div>

        <div id="mainAnalysis" class="analysis">
            <strong>Debugging Strategy:</strong><br>
            Since Test 1 (aspectmode: 'data') shows a sphere in the test but MixingCompass shows distortion,<br>
            there must be a difference in:<br>
            â€¢ Layout settings<br>
            â€¢ Container size<br>
            â€¢ Plotly version<br>
            â€¢ CSS interference<br>
            â€¢ Axis configuration
        </div>

        <div class="comparison">
            <div class="test-box">
                <h2>Exact MixingCompass Recreation</h2>
                <div class="analysis" id="mixingcompass-info">Recreating exact MixingCompass conditions...</div>
                <div id="plotMixingCompass" class="plot-container"></div>
            </div>

            <div class="test-box">
                <h2>Working Test Environment</h2>
                <div class="analysis" id="test-info">Standard test with same data...</div>
                <div id="plotTest" class="plot-container"></div>
            </div>
        </div>

        <div class="analysis" id="comparisonAnalysis">
            Comparison analysis will appear here...
        </div>

        <div class="comparison">
            <div class="test-box">
                <h2>Width/Height Variation Test</h2>
                <div class="analysis" id="size-info">Testing different container sizes...</div>
                <div id="plotSize" class="plot-container"></div>
            </div>

            <div class="test-box">
                <h2>Margin Variation Test</h2>
                <div class="analysis" id="margin-info">Testing different margins...</div>
                <div id="plotMargin" class="plot-container"></div>
            </div>
        </div>

        <div id="settingsInspection" class="analysis" style="display: none;">
            <h3>Plotly Settings Inspection</h3>
            <div id="settingsContent"></div>
        </div>
    </div>

    <script>
        // Exact data from MixingCompass
        const exactData = {
            center: [15.600000000000003, 8.066666666666668, 13.0],
            radius: 6.45428367658083,
            solvents: [
                { name: 'acetone', coords: [15.5, 10.4, 7.0], solubility: 'soluble', color: '#1976d2' },
                { name: 'ethanol', coords: [15.8, 8.8, 19.4], solubility: 'soluble', color: '#1976d2' },
                { name: 'ethyl acetate', coords: [15.8, 5.3, 7.2], solubility: 'partial', color: '#ff9800' },
                { name: 'hexane', coords: [14.9, 0, 0], solubility: 'insoluble', color: '#d32f2f' },
                { name: 'toluene', coords: [18.0, 1.4, 2.0], solubility: 'insoluble', color: '#d32f2f' }
            ]
        };

        // Generate sphere exactly like MixingCompass
        function generateSphere(center, radius, resolution = 20) {
            const x = [];
            const y = [];
            const z = [];

            for (let i = 0; i < resolution; i++) {
                const xRow = [];
                const yRow = [];
                const zRow = [];
                for (let j = 0; j < resolution; j++) {
                    const u = 2 * Math.PI * j / (resolution - 1);
                    const v = Math.PI * i / (resolution - 1);

                    xRow.push(center[0] + radius * Math.cos(u) * Math.sin(v));
                    yRow.push(center[1] + radius * Math.sin(u) * Math.sin(v));
                    zRow.push(center[2] + radius * Math.cos(v));
                }
                x.push(xRow);
                y.push(yRow);
                z.push(zRow);
            }

            return { x, y, z };
        }

        function createMixingCompassTraces() {
            const sphere = generateSphere(exactData.center, exactData.radius, 25);

            return [
                {
                    type: 'surface',
                    x: sphere.x,
                    y: sphere.y,
                    z: sphere.z,
                    name: 'Hansen Sphere',
                    opacity: 0.35,
                    colorscale: [[0, 'rgba(76, 175, 80, 0.3)'], [1, 'rgba(76, 175, 80, 0.3)']],
                    showscale: false,
                    hovertemplate: `Hansen Sphere<br>Center: (${exactData.center[0].toFixed(1)}, ${exactData.center[1].toFixed(1)}, ${exactData.center[2].toFixed(1)})<br>Radius: ${exactData.radius.toFixed(1)}<extra></extra>`
                },
                {
                    type: 'scatter3d',
                    mode: 'markers',
                    x: exactData.solvents.map(s => s.coords[0]),
                    y: exactData.solvents.map(s => s.coords[1]),
                    z: exactData.solvents.map(s => s.coords[2]),
                    name: 'Solvent Points',
                    showlegend: false,
                    marker: {
                        size: 3,
                        color: exactData.solvents.map(s => s.color),
                        symbol: 'circle',
                        opacity: 0.9,
                        line: {
                            width: 0.5,
                            color: 'rgba(255,255,255,0.6)'
                        }
                    },
                    text: exactData.solvents.map(s => s.name),
                    hovertemplate: '<b>%{text}</b><br>Î´D: %{x:.1f}<br>Î´P: %{y:.1f}<br>Î´H: %{z:.1f}<br>Solubility: %{customdata}<extra></extra>',
                    customdata: exactData.solvents.map(s => s.solubility)
                },
                {
                    type: 'scatter3d',
                    mode: 'markers',
                    x: [exactData.center[0]],
                    y: [exactData.center[1]],
                    z: [exactData.center[2]],
                    name: 'Hansen Center',
                    showlegend: false,
                    marker: {
                        size: 3,
                        color: '#32CD32',
                        symbol: 'circle',
                        opacity: 1.0,
                        line: {
                            width: 0.5,
                            color: 'rgba(50,205,50,0.8)'
                        }
                    },
                    hovertemplate: `<b>Hansen Center</b><br>Î´D: ${exactData.center[0].toFixed(1)}<br>Î´P: ${exactData.center[1].toFixed(1)}<br>Î´H: ${exactData.center[2].toFixed(1)}<br>Ra: ${exactData.radius.toFixed(1)}<extra></extra>`
                }
            ];
        }

        function testCurrentMixingCompass() {
            const traces = createMixingCompassTraces();

            // Exact MixingCompass layout recreation
            const mixingCompassLayout = {
                title: {
                    text: `HSP (Î´D: ${exactData.center[0].toFixed(1)}, Î´P: ${exactData.center[1].toFixed(1)}, Î´H: ${exactData.center[2].toFixed(1)}, Ra: ${exactData.radius.toFixed(1)})`,
                    x: 0.5,
                    font: { size: 16 }
                },
                scene: {
                    xaxis: {
                        title: 'Î´D (Dispersion) [MPa<sup>0.5</sup>]',
                        titlefont: { size: 12 }
                    },
                    yaxis: {
                        title: 'Î´P (Polarity) [MPa<sup>0.5</sup>]',
                        titlefont: { size: 12 }
                    },
                    zaxis: {
                        title: 'Î´H (Hydrogen Bonding) [MPa<sup>0.5</sup>]',
                        titlefont: { size: 12 }
                    },
                    camera: {
                        eye: { x: 1.25, y: 1.25, z: 1.25 }
                    },
                    aspectmode: 'manual',
                    aspectratio: { x: 1, y: 1, z: 1 }
                },
                width: 800,  // Exact MixingCompass size
                height: 600,
                margin: { l: 0, r: 0, t: 40, b: 0 },
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(255,255,255,0.95)',
                    bordercolor: 'rgba(0,0,0,0.2)',
                    borderwidth: 1,
                    font: { size: 11 },
                    itemsizing: 'constant',
                    itemwidth: 30
                },
                annotations: [{
                    text: '<b>Solubility Legend</b><br>' +
                          'ðŸ”´ <span style="color:#d32f2f">Poor</span> (< 0.3)<br>' +
                          'ðŸŸ  <span style="color:#ff9800">Partial</span> (0.3-0.7)<br>' +
                          'ðŸ”µ <span style="color:#1976d2">Good</span> (â‰¥ 0.7)<br>' +
                          'ðŸŸ¢ <span style="color:#32CD32">Hansen Center</span><br>' +
                          '<span style="color:#4caf50">â¬› Hansen Sphere</span>',
                    showarrow: false,
                    xref: 'paper',
                    yref: 'paper',
                    x: 0.02,
                    y: 0.35,
                    xanchor: 'left',
                    yanchor: 'top',
                    bgcolor: 'rgba(255,255,255,0.95)',
                    bordercolor: 'rgba(0,0,0,0.2)',
                    borderwidth: 1,
                    font: { size: 11 },
                    align: 'left'
                }]
            };

            Plotly.newPlot('plotMixingCompass', traces, mixingCompassLayout);

            // Test layout (simpler)
            const testLayout = {
                scene: {
                    aspectmode: 'data',
                    camera: { eye: { x: 1.25, y: 1.25, z: 1.25 } },
                    xaxis: { title: 'Î´D [MPa^0.5]' },
                    yaxis: { title: 'Î´P [MPa^0.5]' },
                    zaxis: { title: 'Î´H [MPa^0.5]' }
                },
                title: 'Test Environment (aspectmode: data)',
                width: 800,
                height: 600
            };

            Plotly.newPlot('plotTest', traces, testLayout);

            // Analyze differences
            document.getElementById('mixingcompass-info').innerHTML = `
                <strong>MixingCompass Exact Recreation:</strong><br>
                â€¢ aspectmode: 'manual'<br>
                â€¢ aspectratio: {x:1, y:1, z:1}<br>
                â€¢ Complex annotations<br>
                â€¢ Fixed width/height: 800x600<br>
                â€¢ Multiple layout elements
            `;

            document.getElementById('test-info').innerHTML = `
                <strong>Test Environment:</strong><br>
                â€¢ aspectmode: 'data'<br>
                â€¢ No aspectratio<br>
                â€¢ Simple layout<br>
                â€¢ Same width/height: 800x600<br>
                â€¢ Minimal elements
            `;

            document.getElementById('comparisonAnalysis').innerHTML = `
                <strong>Key Difference Found:</strong><br>
                <div class="difference">
                MixingCompass uses aspectmode: 'manual' + aspectratio: {x:1, y:1, z:1}<br>
                Test uses aspectmode: 'data'
                </div>
                <br>
                <strong>Critical Question:</strong><br>
                If MixingCompass uses 'manual' + aspectratio, why is it still distorted?<br>
                <br>
                <strong>Possible Issues:</strong><br>
                1. Equal axis ranges not being calculated/applied correctly<br>
                2. Annotation interference<br>
                3. Container size constraints<br>
                4. CSS styling conflicts
            `;
        }

        function testAllVariations() {
            // Test with different sizes
            const traces = createMixingCompassTraces();

            // Size variation test (MixingCompass container size)
            const sizeLayout = {
                scene: {
                    aspectmode: 'manual',
                    aspectratio: { x: 1, y: 1, z: 1 },
                    camera: { eye: { x: 1.25, y: 1.25, z: 1.25 } }
                },
                title: 'MixingCompass Container Size (890x600)',
                width: 890,  // Actual MixingCompass container size
                height: 600
            };

            Plotly.newPlot('plotSize', traces, sizeLayout);

            // Margin variation test
            const marginLayout = {
                scene: {
                    aspectmode: 'manual',
                    aspectratio: { x: 1, y: 1, z: 1 },
                    camera: { eye: { x: 1.25, y: 1.25, z: 1.25 } }
                },
                title: 'Different Margins Test',
                width: 800,
                height: 600,
                margin: { l: 50, r: 50, t: 50, b: 50 }  // Different margins
            };

            Plotly.newPlot('plotMargin', traces, marginLayout);

            document.getElementById('size-info').innerHTML = `
                <strong>Container Size Test:</strong><br>
                Width: 890px (actual MixingCompass)<br>
                Height: 600px<br>
                This tests if container size affects sphere rendering
            `;

            document.getElementById('margin-info').innerHTML = `
                <strong>Margin Test:</strong><br>
                Different margins: 50px all sides<br>
                vs MixingCompass: {l:0, r:0, t:40, b:0}
            `;
        }

        function inspectPlotlySettings() {
            document.getElementById('settingsInspection').style.display = 'block';

            const plotElement = document.getElementById('plotMixingCompass');

            // Wait for plot to be ready
            setTimeout(() => {
                if (plotElement && plotElement.data && plotElement.layout) {
                    const settings = {
                        plotlyVersion: Plotly.version,
                        dataLength: plotElement.data.length,
                        sceneSettings: plotElement.layout.scene,
                        dimensions: {
                            width: plotElement.layout.width,
                            height: plotElement.layout.height
                        }
                    };

                    document.getElementById('settingsContent').innerHTML = `
                        <strong>Plotly Version:</strong> ${settings.plotlyVersion}<br>
                        <strong>Data Traces:</strong> ${settings.dataLength}<br>
                        <strong>Scene Settings:</strong><br>
                        <pre>${JSON.stringify(settings.sceneSettings, null, 2)}</pre>
                        <strong>Dimensions:</strong><br>
                        Width: ${settings.dimensions.width}px<br>
                        Height: ${settings.dimensions.height}px
                    `;
                } else {
                    document.getElementById('settingsContent').innerHTML = 'Plot not ready yet, try again in a moment.';
                }
            }, 2000);
        }

        // Auto-run basic test
        window.onload = () => {
            setTimeout(testCurrentMixingCompass, 1000);
        };
    </script>
</body>
</html>