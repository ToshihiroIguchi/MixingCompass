<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Prediction Method - {{ app_name }}</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/styles.css?v=20251122METHOD">
    <style>
        .method-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
        }

        .method-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #1e3a8a;
        }

        .method-header h1 {
            color: #1e3a8a;
            margin-bottom: 0.5rem;
        }

        .method-header .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #1e3a8a;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h2 {
            color: #1e3a8a;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .section h3 {
            color: #334155;
            margin: 1.5rem 0 0.5rem 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f1f5f9;
            font-weight: 600;
        }

        .data-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .figure {
            margin: 1.5rem 0;
            text-align: center;
        }

        .figure img {
            max-width: 100%;
            height: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .figure-caption {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
        }

        .reference {
            background: #f8fafc;
            padding: 1rem;
            border-left: 4px solid #1e3a8a;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        .reference a {
            color: #1e40af;
        }

        .highlight-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .print-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e3a8a;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .print-btn:hover {
            background: #1e40af;
        }

        @media print {
            .back-link, .print-btn {
                display: none;
            }
            .method-container {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/static/images/mc_logo.png" alt="MixingCompass Logo" class="logo">
                <h1>{{ app_name }}</h1>
            </div>
        </div>
    </header>

    <main class="main-content" style="padding-top: 80px;">
        <div class="method-container">
            <a href="/" class="back-link">&larr; Back to MixingCompass</a>

            <div class="method-header">
                <h1>Machine Learning Prediction Method</h1>
                <p class="subtitle">Hansen Solubility Parameters and Boiling Point from SMILES</p>
            </div>

            <!-- Abstract -->
            <section class="section">
                <h2>Abstract</h2>
                <p>
                    This document describes the machine learning approach used in MixingCompass for predicting
                    Hansen Solubility Parameters (δD, δP, δH) and Boiling Point (Tv) from molecular SMILES strings.
                    GradientBoosting regression models were trained using RDKit molecular descriptors as features,
                    achieving R&sup2; values of 0.70-0.86 across all target properties.
                </p>
            </section>

            <!-- Data Source -->
            <section class="section">
                <h2>Data Source</h2>
                <div class="reference">
                    <strong>Training Data Citation:</strong><br>
                    Niederquell, A., &amp; Kuentz, M. (2018).
                    <em>Solvent data for pharmaceutical and chemical industry - Useful physicochemical data of common solvents.</em>
                    Mendeley Data, V1.<br>
                    <a href="https://doi.org/10.17632/b4dmjzk8w6.1" target="_blank">https://doi.org/10.17632/b4dmjzk8w6.1</a>
                </div>
                <p>
                    The dataset contains physicochemical properties of 499 common solvents used in pharmaceutical
                    and chemical applications, including SMILES structures, Hansen Solubility Parameters,
                    and boiling points.
                </p>
            </section>

            <!-- Methods -->
            <section class="section">
                <h2>Methods</h2>

                <h3>RDKit: Molecular Descriptor Calculation</h3>
                <p>
                    <strong>RDKit</strong> is an open-source cheminformatics library that provides a comprehensive
                    suite of tools for processing and analyzing chemical structures. In this application, RDKit
                    is used to convert SMILES (Simplified Molecular Input Line Entry System) strings into
                    numerical molecular descriptors that can be used as input features for machine learning models.
                </p>

                <div class="highlight-box">
                    <strong>SMILES Representation:</strong><br>
                    SMILES is a linear notation for describing chemical structures using ASCII characters.
                    For example:
                    <ul>
                        <li><code>CCO</code> → Ethanol (C-C-O)</li>
                        <li><code>c1ccccc1</code> → Benzene (aromatic ring)</li>
                        <li><code>CC(=O)O</code> → Acetic acid</li>
                    </ul>
                </div>

                <h4>Molecular Descriptors</h4>
                <p>
                    RDKit calculates over 200 molecular descriptors from SMILES structures. After preprocessing
                    (removing features with NaN, infinite values, or zero variance), <strong>164 descriptors</strong>
                    were retained for model training. These descriptors are categorized as follows:
                </p>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Examples</th>
                            <th>Physical Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Constitutional</strong></td>
                            <td>MolWt, HeavyAtomCount, NumRotatableBonds</td>
                            <td>Basic molecular composition (atom counts, bond counts, molecular weight)</td>
                        </tr>
                        <tr>
                            <td><strong>Topological</strong></td>
                            <td>BalabanJ, BertzCT, Chi0-Chi4</td>
                            <td>Molecular connectivity and branching patterns</td>
                        </tr>
                        <tr>
                            <td><strong>Electronic</strong></td>
                            <td>TPSA, MolLogP, MolMR</td>
                            <td>Polar surface area, lipophilicity, molar refractivity</td>
                        </tr>
                        <tr>
                            <td><strong>Fragment-based</strong></td>
                            <td>fr_C_O, fr_NH2, fr_benzene</td>
                            <td>Counts of specific functional groups (C=O, -NH2, benzene rings, etc.)</td>
                        </tr>
                        <tr>
                            <td><strong>Ring descriptors</strong></td>
                            <td>RingCount, NumAromaticRings, NumAliphaticRings</td>
                            <td>Ring system characteristics</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Gradient Boosting Regression</h3>
                <p>
                    <strong>Gradient Boosting</strong> is an ensemble machine learning technique that builds
                    a predictive model by combining multiple weak learners (typically decision trees) in a
                    sequential manner. Each subsequent tree is trained to correct the errors of the previous
                    ensemble, leading to progressively better predictions.
                </p>

                <h4>Algorithm Principle</h4>
                <p>The gradient boosting algorithm works as follows:</p>
                <ol>
                    <li><strong>Initialize:</strong> Start with a simple model (e.g., mean of target values)</li>
                    <li><strong>Compute Residuals:</strong> Calculate the difference between actual and predicted values</li>
                    <li><strong>Fit New Tree:</strong> Train a decision tree to predict these residuals</li>
                    <li><strong>Update Model:</strong> Add the new tree to the ensemble with a learning rate weight</li>
                    <li><strong>Repeat:</strong> Continue steps 2-4 for the specified number of iterations</li>
                </ol>

                <div class="highlight-box">
                    <strong>Mathematical Formulation:</strong><br>
                    The prediction at iteration <em>m</em> is updated as:<br>
                    <code style="font-size: 1.1em;">F<sub>m</sub>(x) = F<sub>m-1</sub>(x) + η · h<sub>m</sub>(x)</code><br><br>
                    Where:
                    <ul>
                        <li><code>F<sub>m</sub>(x)</code> = prediction at iteration m</li>
                        <li><code>η</code> = learning rate (0.1 in our model)</li>
                        <li><code>h<sub>m</sub>(x)</code> = new tree fitted to residuals</li>
                    </ul>
                </div>

                <h4>Why Gradient Boosting?</h4>
                <ul>
                    <li><strong>Non-linear Relationships:</strong> Can capture complex, non-linear relationships between molecular descriptors and physical properties</li>
                    <li><strong>Feature Interactions:</strong> Automatically discovers interactions between different molecular features</li>
                    <li><strong>Robustness:</strong> Resistant to overfitting when properly tuned, and handles mixed feature types well</li>
                    <li><strong>Interpretability:</strong> Provides feature importance scores to understand which descriptors are most predictive</li>
                </ul>

                <h3>Model Configuration</h3>
                <div class="highlight-box">
                    <strong>Algorithm:</strong> GradientBoostingRegressor (scikit-learn)<br><br>
                    <strong>Hyperparameters:</strong>
                    <table class="data-table" style="margin-top: 0.5rem;">
                        <tr>
                            <td><code>n_estimators: 100</code></td>
                            <td>Number of boosting stages (trees in the ensemble)</td>
                        </tr>
                        <tr>
                            <td><code>max_depth: 5</code></td>
                            <td>Maximum depth of individual trees (controls model complexity)</td>
                        </tr>
                        <tr>
                            <td><code>learning_rate: 0.1</code></td>
                            <td>Shrinkage parameter to prevent overfitting</td>
                        </tr>
                        <tr>
                            <td><code>random_state: 42</code></td>
                            <td>Seed for reproducibility</td>
                        </tr>
                    </table>
                    <br>
                    <strong>Feature Preprocessing:</strong> StandardScaler (z-score normalization)<br>
                    <code>z = (x - μ) / σ</code> where μ = mean, σ = standard deviation
                </div>

                <h3>Validation Strategy</h3>
                <p>
                    <strong>5-Fold Cross-Validation</strong> was employed to provide robust performance estimates
                    and detect potential overfitting:
                </p>
                <ol>
                    <li>The dataset is randomly divided into 5 equal-sized subsets (folds)</li>
                    <li>For each fold: train on 4 folds (80% of data), test on remaining fold (20%)</li>
                    <li>Repeat for all 5 combinations</li>
                    <li>Report mean and standard deviation of performance metrics</li>
                </ol>
                <p>
                    This approach ensures that every data point is used for both training and testing exactly once,
                    providing a reliable estimate of model generalization performance.
                </p>
            </section>

            <!-- Results -->
            <section class="section">
                <h2>Results</h2>

                <h3>Cross-Validation Performance</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Description</th>
                            <th>R&sup2;</th>
                            <th>MAE</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>δD</strong></td>
                            <td>Dispersion forces</td>
                            <td>0.858</td>
                            <td>0.36</td>
                            <td>MPa<sup>0.5</sup></td>
                        </tr>
                        <tr>
                            <td><strong>δP</strong></td>
                            <td>Polar forces</td>
                            <td>0.696</td>
                            <td>1.15</td>
                            <td>MPa<sup>0.5</sup></td>
                        </tr>
                        <tr>
                            <td><strong>δH</strong></td>
                            <td>Hydrogen bonding</td>
                            <td>0.794</td>
                            <td>0.94</td>
                            <td>MPa<sup>0.5</sup></td>
                        </tr>
                        <tr>
                            <td><strong>Tv</strong></td>
                            <td>Boiling point</td>
                            <td>0.864</td>
                            <td>15.14</td>
                            <td>&deg;C</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Figure 1: Predicted vs Literature Values</h3>
                <div class="figure">
                    <img src="/static/images/ml/cv_scatter_plots.png" alt="Cross-validation scatter plots">
                    <p class="figure-caption">
                        Figure 1. Scatter plots comparing predicted values (y-axis) against literature values (x-axis)
                        for all four target properties. Dashed line represents perfect prediction (y=x).
                        R&sup2; and MAE values are shown for each property.
                    </p>
                </div>

                <h3>Figure 2: R&sup2; Score Summary</h3>
                <div class="figure">
                    <img src="/static/images/ml/cv_summary.png" alt="R2 score summary">
                    <p class="figure-caption">
                        Figure 2. Bar chart comparing R&sup2; scores across all target properties.
                        Horizontal lines indicate R&sup2; = 0.8 and R&sup2; = 0.7 thresholds.
                    </p>
                </div>

                <h3>Figure 3: Prediction Error Distributions</h3>
                <div class="figure">
                    <img src="/static/images/ml/cv_error_distributions.png" alt="Error distributions">
                    <p class="figure-caption">
                        Figure 3. Histograms showing the distribution of prediction errors for each property.
                        Red vertical line indicates the mean error. All distributions are centered near zero,
                        indicating no systematic bias.
                    </p>
                </div>
            </section>

            <!-- Discussion -->
            <section class="section">
                <h2>Discussion</h2>

                <h3>Key Findings</h3>
                <ol>
                    <li>
                        <strong>Dispersion (δD):</strong> Achieved R&sup2; = 0.858, indicating strong predictive performance.
                        This is expected as dispersion forces correlate well with molecular size and structure,
                        which are well-captured by RDKit descriptors.
                    </li>
                    <li>
                        <strong>Polar (δP):</strong> R&sup2; = 0.696, showing moderate correlation. Polar interactions
                        are more complex and depend on molecular geometry and charge distribution, which may require
                        3D conformer analysis for improved accuracy.
                    </li>
                    <li>
                        <strong>H-bonding (δH):</strong> R&sup2; = 0.794, reflecting the complexity of hydrogen bonding
                        which depends on specific functional groups and their accessibility.
                    </li>
                    <li>
                        <strong>Boiling Point (Tv):</strong> R&sup2; = 0.864, demonstrating strong predictive capability
                        for this fundamental thermodynamic property.
                    </li>
                </ol>
            </section>

            <!-- Feature Importance -->
            <section class="section">
                <h2>Feature Importance Analysis</h2>
                <p>
                    Gradient Boosting models provide <strong>feature importance scores</strong> that indicate
                    how much each molecular descriptor contributes to the prediction. Feature importance is
                    calculated based on the reduction in impurity (mean squared error) achieved by each feature
                    across all decision trees in the ensemble.
                </p>

                <h3>Figure 4: Feature Importance by Target Property</h3>
                <div class="figure">
                    <img src="/static/images/ml/feature_importance.png" alt="Feature importance by target">
                    <p class="figure-caption">
                        Figure 4. Top 20 most important features for each target property. Different properties
                        rely on different molecular descriptors, reflecting the distinct physical mechanisms
                        underlying each Hansen parameter.
                    </p>
                </div>

                <h3>Figure 5: Average Feature Importance</h3>
                <div class="figure">
                    <img src="/static/images/ml/feature_importance_average.png" alt="Average feature importance">
                    <p class="figure-caption">
                        Figure 5. Top 25 features ranked by average importance across all four target properties.
                        These descriptors are the most universally predictive for solvent properties.
                    </p>
                </div>

                <h3>Interpretation of Key Features</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Description</th>
                            <th>Physical Relevance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>MolLogP</strong></td>
                            <td>Wildman-Crippen LogP</td>
                            <td>Lipophilicity indicator; correlates with dispersion interactions</td>
                        </tr>
                        <tr>
                            <td><strong>TPSA</strong></td>
                            <td>Topological Polar Surface Area</td>
                            <td>Measures polar surface; correlates with H-bonding and polar parameters</td>
                        </tr>
                        <tr>
                            <td><strong>MolWt</strong></td>
                            <td>Molecular Weight</td>
                            <td>Size indicator; affects boiling point and dispersion forces</td>
                        </tr>
                        <tr>
                            <td><strong>fr_* descriptors</strong></td>
                            <td>Functional group counts</td>
                            <td>Counts of specific groups (-OH, -NH, C=O, etc.) directly relate to H-bonding</td>
                        </tr>
                        <tr>
                            <td><strong>Chi*</strong></td>
                            <td>Kier-Hall Connectivity indices</td>
                            <td>Molecular branching and connectivity patterns</td>
                        </tr>
                        <tr>
                            <td><strong>VSA_*</strong></td>
                            <td>MOE-type surface area descriptors</td>
                            <td>Surface area contributions by atom type and charge</td>
                        </tr>
                    </tbody>
                </table>

                <div class="highlight-box">
                    <strong>Note on Interpretation:</strong><br>
                    Feature importance in Gradient Boosting indicates predictive utility, not necessarily
                    direct physical causation. Correlated features may share importance, and the most
                    physically meaningful feature is not always the most statistically predictive.
                </div>
            </section>

            <!-- Limitations -->
            <section class="section">
                <h2>Limitations</h2>
                <ul>
                    <li>
                        <strong>Domain of Applicability:</strong> Models are trained on common solvents.
                        Predictions for molecules significantly different from the training set may be unreliable.
                    </li>
                    <li>
                        <strong>Functional Group Coverage:</strong> Unusual functional groups not well-represented
                        in the training data may lead to larger prediction errors.
                    </li>
                    <li>
                        <strong>Stereochemistry:</strong> The model does not distinguish stereoisomers as
                        RDKit 2D descriptors are used.
                    </li>
                </ul>
            </section>

            <!-- Usage -->
            <section class="section">
                <h2>Usage</h2>
                <h3>Web Interface</h3>
                <p>Navigate to "Predict from SMILES" in MixingCompass and enter a SMILES string.</p>

                <h3>Python API</h3>
                <div class="code-block">
<pre>from app.ml import predict_from_smiles

# Single prediction
result = predict_from_smiles('CCO')  # Ethanol
print(result)
# {'smiles': 'CCO', 'is_valid': True, 'dD': 15.8, 'dP': 8.94, 'dH': 19.28, 'Tv': 79.32}

# Batch prediction
results = predict_from_smiles(['CCO', 'CCCCCC', 'c1ccccc1'])</pre>
                </div>

                <h3>REST API</h3>
                <div class="code-block">
<pre>POST /api/predict/single
Content-Type: application/json

{"smiles": "CCO"}

Response:
{"smiles": "CCO", "is_valid": true, "dD": 15.8, "dP": 8.94, "dH": 19.28, "Tv": 79.32}</pre>
                </div>
            </section>

            <!-- References -->
            <section class="section">
                <h2>References</h2>
                <ol>
                    <li>
                        Hansen, C. M. (2007). <em>Hansen Solubility Parameters: A User's Handbook, Second Edition.</em>
                        CRC Press.
                    </li>
                    <li>
                        Niederquell, A., &amp; Kuentz, M. (2018). Solvent data for pharmaceutical and chemical industry -
                        Useful physicochemical data of common solvents. Mendeley Data, V1.
                        <a href="https://doi.org/10.17632/b4dmjzk8w6.1" target="_blank">https://doi.org/10.17632/b4dmjzk8w6.1</a>
                    </li>
                    <li>
                        RDKit: Open-source cheminformatics. <a href="https://www.rdkit.org" target="_blank">https://www.rdkit.org</a>
                    </li>
                    <li>
                        Pedregosa, F. et al. (2011). Scikit-learn: Machine Learning in Python.
                        <em>Journal of Machine Learning Research</em>, 12, 2825-2830.
                    </li>
                </ol>
            </section>

            <hr style="margin: 2rem 0;">
            <p style="text-align: center; color: #666; font-size: 0.9rem;">
                Generated by MixingCompass | Last updated: November 2024
            </p>
        </div>

        <button class="print-btn" onclick="window.print()">Print / Save PDF</button>
    </main>
</body>
</html>
