<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }}</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/styles.css?v=20251123MODAL">
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section clickable" data-section="home" title="Go to Home">
                <img src="/static/images/mc_logo.png" alt="MixingCompass Logo" class="logo">
                <h1>{{ app_name }}</h1>
            </div>
            <nav class="navigation">
                <button class="nav-btn" data-section="hsp-experimental">HSP from Experiments</button>
                <button class="nav-btn" data-section="smiles-predict">Predict from SMILES</button>
                <button class="nav-btn" data-section="hsp-calculation">Mix Solvents</button>
                <button class="nav-btn" data-section="solvent-search">Search Solvents</button>
                <button class="nav-btn" data-section="data-list">Data Manager</button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <!-- Home Section -->
        <section id="home" class="content-section active">
            <div class="home-container">
                <div class="home-header">
                    <h1>Welcome to MixingCompass</h1>
                    <p class="home-subtitle">Hansen Solubility Parameter Analysis Tool</p>
                </div>

                <div class="feature-cards">
                    <div class="feature-card" data-section="hsp-experimental">
                        <div class="feature-icon">üß™</div>
                        <h3>HSP from Experiments</h3>
                        <p>Determine Hansen Solubility Parameters from experimental solubility data using dissolution tests.</p>
                        <button class="feature-btn">Get Started</button>
                    </div>

                    <div class="feature-card" data-section="smiles-predict">
                        <div class="feature-icon">üß†</div>
                        <h3>Predict from SMILES</h3>
                        <p>Predict HSP and boiling point from molecular SMILES using machine learning.</p>
                        <button class="feature-btn">Get Started</button>
                    </div>

                    <div class="feature-card" data-section="hsp-calculation">
                        <div class="feature-icon">‚öóÔ∏è</div>
                        <h3>Mix Solvents</h3>
                        <p>Calculate HSP values for solvent mixtures using volume fraction weighted averaging.</p>
                        <button class="feature-btn">Get Started</button>
                    </div>

                    <div class="feature-card" data-section="solvent-search">
                        <div class="feature-icon">üîç</div>
                        <h3>Search Solvents</h3>
                        <p>Find compatible solvents by searching the database using target HSP values and RED criteria.</p>
                        <button class="feature-btn">Get Started</button>
                    </div>

                    <div class="feature-card" data-section="data-list">
                        <div class="feature-icon">üóÉÔ∏è</div>
                        <h3>Data Manager</h3>
                        <p>Browse and manage the solvent database, including user solvents and saved mixtures.</p>
                        <button class="feature-btn">Get Started</button>
                    </div>
                </div>

                <div class="home-footer">
                    <p>Database contains <span id="home-solvent-count">2400+</span> solvents with HSP data</p>
                </div>
            </div>
        </section>

        <!-- HSP Experimental Section -->
        <section id="hsp-experimental" class="content-section">
            <div class="split-layout">
                <div class="left-panel">
                    <div class="panel-header">
                        <h2>HSP from Experiments</h2>
                        <button id="load-data-btn" class="btn btn-secondary">Load Data</button>
                    </div>
                    <div class="sample-info">
                        <label>Sample Name:</label>
                        <input type="text" id="sample-name" placeholder="Enter sample name" required>
                    </div>
                    <div id="solvent-table-container" class="data-table-container">
                        <!-- Solvent table will be dynamically generated -->
                    </div>
                    <div class="calculation-section">
                        <div class="calculation-status" id="calculation-status"></div>
                    </div>
                </div>
                <div class="right-panel">
                    <div class="panel-action-buttons">
                        <button id="calculate-btn" class="btn btn-primary">Analyze & Visualize</button>
                        <button id="calculation-settings-btn" class="btn btn-secondary">‚öôÔ∏è Settings</button>
                    </div>
                    <div class="results-section">
                        <div class="results-header">
                            <h3>HSP</h3>
                            <div class="hsp-values-inline">
                                <span class="hsp-value-inline">
                                    <label>&delta;D:</label>
                                    <span id="delta-d" class="value">-</span>
                                    <span class="unit">MPa<sup>0.5</sup></span>
                                </span>
                                <span class="hsp-value-inline">
                                    <label>&delta;P:</label>
                                    <span id="delta-p" class="value">-</span>
                                    <span class="unit">MPa<sup>0.5</sup></span>
                                </span>
                                <span class="hsp-value-inline">
                                    <label>&delta;H:</label>
                                    <span id="delta-h" class="value">-</span>
                                    <span class="unit">MPa<sup>0.5</sup></span>
                                </span>
                                <span class="hsp-value-inline">
                                    <label>R0:</label>
                                    <span id="ra" class="value">-</span>
                                    <span class="unit">MPa<sup>0.5</sup></span>
                                </span>
                            </div>
                            <div class="result-actions">
                                <button id="details-info-btn" class="info-btn" title="View calculation details" style="display: none;">‚ìò</button>
                                <button id="copy-hsp-btn" class="info-btn" title="Copy HSP data for Excel" style="display: none;">üìã</button>
                            </div>
                        </div>
                    </div>
                    <div class="hansen-sphere" id="hansen-sphere-container">
                        <div class="viz-tabs">
                            <button class="viz-tab active" data-view="view-3d">3D View</button>
                            <button class="viz-tab" data-view="view-2d">2D Projections</button>
                        </div>
                        <div id="view-3d" class="view-panel active">
                            <div id="plotly-visualization" class="plotly-container">
                                <div class="visualization-placeholder">
                                    <p>Calculate HSP to display 3D Hansen sphere</p>
                                    <small>Interactive 3D visualization will appear after calculation</small>
                                </div>
                            </div>
                        </div>
                        <div id="view-2d" class="view-panel" style="display: none;">
                            <div id="plot-2d-subplots" class="plot-2d-subplots"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="save-result-btn" class="btn btn-primary" disabled>Save Result</button>
                        <button id="export-package-btn" class="btn btn-secondary" disabled>Export Package (ZIP)</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Calculation Details Modal -->
        <div id="calculation-details-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Calculation Details</h4>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body" id="modal-calculation-details">
                    <!-- Details will be populated here -->
                </div>
            </div>
        </div>

        <!-- Load Data Modal -->
        <div id="load-data-modal" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Load Experimental Result</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="search-section">
                        <input type="text" id="result-search" class="search-input" placeholder="Search by sample name...">
                    </div>
                    <div id="results-list" class="results-list">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancel-load-data" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- HSP Calculation Section -->
        <section id="hsp-calculation" class="content-section">
            <div class="single-panel-layout">
                <div class="panel-header">
                    <h2>Mix Solvents</h2>
                </div>
                <div class="mixture-info">
                    <label>Mixture Name:</label>
                    <input type="text" id="mixture-name" placeholder="Enter mixture name" required>
                </div>
                <div class="mixture-table-section">
                    <div class="mixture-table-header">
                        <h3>Components</h3>
                        <div class="solvent-set-controls">
                            <select id="calc-solvent-set-selector" class="solvent-set-select">
                                <option value="">Select saved solvent set...</option>
                            </select>
                            <button id="calc-load-solvent-set-btn" class="btn btn-secondary btn-small" disabled>Load</button>
                            <div class="save-set-group">
                                <input type="text" id="calc-new-set-name" class="set-name-input" placeholder="Set name">
                                <button id="calc-save-solvent-set-btn" class="btn btn-primary btn-small">Save</button>
                            </div>
                            <button id="calc-new-experiment-btn" class="btn btn-secondary btn-small" title="Clear all components">New</button>
                        </div>
                        <span id="total-volume" class="volume-total">Total Ratio: 0</span>
                    </div>
                    <div id="mixture-components-container" class="mixture-components-container">
                        <!-- Component rows will be added here -->
                    </div>
                    <button id="add-component-btn" class="btn btn-secondary">+ Add Solvent</button>
                </div>
                <div class="mixture-actions">
                    <button id="calculate-mixture-btn" class="btn btn-primary" disabled>Calculate HSP</button>
                </div>
                <div id="mixture-result-section" class="mixture-result-section" style="display: none;">
                    <h3>Calculated HSP</h3>
                    <div class="hsp-values-inline">
                        <span class="hsp-value-inline">
                            <label>&delta;D:</label>
                            <span id="mixture-delta-d" class="value">-</span>
                            <span class="unit">MPa<sup>0.5</sup></span>
                        </span>
                        <span class="hsp-value-inline">
                            <label>&delta;P:</label>
                            <span id="mixture-delta-p" class="value">-</span>
                            <span class="unit">MPa<sup>0.5</sup></span>
                        </span>
                        <span class="hsp-value-inline">
                            <label>&delta;H:</label>
                            <span id="mixture-delta-h" class="value">-</span>
                            <span class="unit">MPa<sup>0.5</sup></span>
                        </span>
                    </div>
                    <button id="save-mixture-btn" class="btn btn-primary">Save Mixture</button>
                </div>
            </div>
        </section>

        <!-- Solvent Search Section -->
        <section id="solvent-search" class="content-section">
            <div class="split-layout">
                <!-- Left Panel: Target Configuration -->
                <div class="left-panel" id="solvent-search-left-panel">
                    <div class="panel-header">
                        <h2>Solvent Search</h2>
                        <button id="panel-collapse-btn" class="panel-header-collapse-btn" title="Hide panel">‚óÄ</button>
                    </div>

                    <!-- Target 1 -->
                    <div class="search-section">
                        <div class="target-header">
                            <h3>Target 1</h3>
                            <div class="source-toggle" id="target1-source-toggle">
                                <button class="toggle-btn active" data-source="polymer" data-target="target1">Polymer</button>
                                <button class="toggle-btn" data-source="custom" data-target="target1">Custom</button>
                            </div>
                        </div>
                        <div id="target1-content">
                            <!-- Content will be dynamically populated based on selection -->
                        </div>
                    </div>

                    <!-- Target 2 -->
                    <div class="search-section">
                        <div class="target-header">
                            <h3>Target 2</h3>
                            <div class="source-toggle" id="target2-source-toggle">
                                <button class="toggle-btn active" data-source="polymer" data-target="target2">Polymer</button>
                                <button class="toggle-btn" data-source="custom" data-target="target2">Custom</button>
                            </div>
                        </div>
                        <div id="target2-content">
                            <!-- Content will be dynamically populated based on selection -->
                        </div>
                    </div>

                    <!-- Target 3 -->
                    <div class="search-section">
                        <div class="target-header">
                            <h3>Target 3</h3>
                            <div class="source-toggle" id="target3-source-toggle">
                                <button class="toggle-btn active" data-source="polymer" data-target="target3">Polymer</button>
                                <button class="toggle-btn" data-source="custom" data-target="target3">Custom</button>
                            </div>
                        </div>
                        <div id="target3-content">
                            <!-- Content will be dynamically populated based on selection -->
                        </div>
                    </div>

                    <!-- Search Button -->
                    <button id="search-solvents-btn" class="btn btn-primary" disabled>Search Solvents</button>
                </div>

                <!-- Panel Boundary Toggle Button -->
                <button id="panel-boundary-btn" class="panel-boundary-btn" title="Toggle panel">‚óÄ</button>

                <!-- Collapsed State Toggle Button -->
                <button id="panel-expand-btn" class="panel-expand-btn" title="Expand panel" style="display: none;">‚ò∞</button>

                <!-- Right Panel: Split into Results Table (left) and Visualization (right) -->
                <div class="right-panel">
                    <div class="search-results-split">
                        <!-- Left: Results Table -->
                        <div class="results-area" id="results-panel">
                            <button class="panel-collapse-btn collapsed-btn" id="results-expand-btn" title="Expand results panel" style="display: none;">‚ñ∂</button>
                            <div class="results-panel-header">
                                <h3>Solvent Results</h3>
                                <div id="results-count-display" class="results-count-display"></div>
                                <button id="export-csv-btn" class="btn btn-secondary btn-small" style="display: none;">Export CSV</button>
                                <button class="panel-collapse-btn" id="results-collapse-btn" title="Collapse results panel">‚óÄ</button>
                            </div>

                            <!-- Results Table (Tabulator) -->
                            <div class="results-table-container">
                                <div id="solvent-results-table"></div>
                            </div>
                        </div>

                        <!-- Right: Visualization -->
                        <div class="visualization-area" id="visualization-panel">
                            <button class="panel-collapse-btn collapsed-btn" id="viz-expand-btn" title="Expand visualization panel" style="display: none;">‚óÄ</button>
                            <div class="hansen-sphere" id="search-hansen-sphere-container">
                                <div class="viz-tabs">
                                    <button id="search-tab-3d" class="viz-tab active">3D View</button>
                                    <button id="search-tab-2d" class="viz-tab">2D Projections</button>
                                    <button id="search-tab-red" class="viz-tab" style="display: none;">RED Plot</button>
                                    <button class="panel-collapse-btn" id="viz-collapse-btn" title="Collapse visualization panel">‚ñ∂</button>
                                </div>
                                <div id="search-view-3d" class="view-panel active">
                                    <div id="search-plotly-visualization" class="plotly-container">
                                        <div class="visualization-placeholder">
                                            <p>Configure targets to display Hansen sphere visualization</p>
                                            <small>3D visualization will appear after setting target HSP values</small>
                                        </div>
                                    </div>
                                </div>
                                <div id="search-view-2d" class="view-panel" style="display: none;">
                                    <div id="search-plot-2d-subplots" class="plot-2d-subplots"></div>
                                </div>
                                <div id="search-view-red" class="view-panel" style="display: none;">
                                    <div id="search-plot-red-scatter" class="plot-red-scatter"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SMILES Prediction Section -->
        <section id="smiles-predict" class="content-section">
            <div class="smiles-predict-container">
                <div class="smiles-predict-header">
                    <h2>Predict Properties from SMILES</h2>
                    <p class="section-description">
                        Predict Hansen Solubility Parameters (Œ¥D, Œ¥P, Œ¥H) and Boiling Point (Tv) from molecular SMILES using machine learning.
                    </p>
                </div>

                <div class="smiles-input-section">
                    <div class="input-group">
                        <label for="smiles-input">Enter SMILES:</label>
                        <div class="smiles-input-row">
                            <input type="text" id="smiles-input" class="form-input smiles-input"
                                   placeholder="e.g., CCO (Ethanol), c1ccccc1 (Benzene)"
                                   autocomplete="off">
                            <button id="predict-btn" class="btn btn-primary">Predict</button>
                            <button id="clear-smiles-btn" class="btn btn-secondary">Clear</button>
                        </div>
                        <small class="input-hint">Enter a valid SMILES string representing the molecular structure</small>
                    </div>
                </div>

                <div class="prediction-results-section" id="prediction-results" style="display: none;">
                    <h3>Prediction Results</h3>

                    <!-- Molecular Information -->
                    <div class="molecular-info-row">
                        <div class="molecular-info-item">
                            <label>Formula:</label>
                            <span id="pred-formula" class="formula-value">-</span>
                        </div>
                        <div class="molecular-info-item">
                            <label>Type:</label>
                            <span id="pred-cho" class="cho-badge">-</span>
                        </div>
                    </div>

                    <div class="results-grid">
                        <div class="result-card">
                            <h4>Hansen Solubility Parameters</h4>
                            <div class="hsp-results">
                                <div class="hsp-value-item">
                                    <label>&delta;D:</label>
                                    <span id="pred-dD" class="value">-</span>
                                    <span class="unit">MPa<sup>0.5</sup></span>
                                </div>
                                <div class="hsp-value-item">
                                    <label>&delta;P:</label>
                                    <span id="pred-dP" class="value">-</span>
                                    <span class="unit">MPa<sup>0.5</sup></span>
                                </div>
                                <div class="hsp-value-item">
                                    <label>&delta;H:</label>
                                    <span id="pred-dH" class="value">-</span>
                                    <span class="unit">MPa<sup>0.5</sup></span>
                                </div>
                            </div>
                        </div>
                        <div class="result-card">
                            <h4>Boiling Point</h4>
                            <div class="tv-result">
                                <span id="pred-Tv" class="value large">-</span>
                                <span class="unit">&deg;C</span>
                            </div>
                        </div>
                    </div>

                    <!-- Save to Database Section -->
                    <div class="save-prediction-section">
                        <h4>Save to User Solvents</h4>
                        <div class="save-input-row">
                            <input type="text" id="solvent-name-input" class="form-input"
                                   placeholder="Enter solvent name (required)" maxlength="100">
                            <button id="save-prediction-btn" class="btn btn-primary" disabled>Save</button>
                        </div>
                        <small class="input-hint">Name is required to save. The solvent will be available in HSP calculations and searches.</small>
                    </div>

                    <div class="action-buttons">
                        <button id="copy-prediction-btn" class="btn btn-secondary">Copy Results</button>
                    </div>
                </div>

                <div class="prediction-error" id="prediction-error" style="display: none;">
                    <p id="error-message"></p>
                </div>

                <div class="method-info">
                    <details>
                        <summary>About the Prediction Method</summary>
                        <div class="method-details">
                            <p><strong>Algorithm:</strong> GradientBoosting Regressor with RDKit molecular descriptors</p>
                            <p><strong>Training Data:</strong> 499 solvents from Niederquell & Kuentz (2018)</p>
                            <p><strong>Cross-Validation Performance (5-Fold):</strong></p>
                            <table class="performance-table">
                                <thead>
                                    <tr><th>Property</th><th>R&sup2;</th><th>MAE</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Œ¥D</td><td>0.858</td><td>0.36 MPa<sup>0.5</sup></td></tr>
                                    <tr><td>Œ¥P</td><td>0.696</td><td>1.15 MPa<sup>0.5</sup></td></tr>
                                    <tr><td>Œ¥H</td><td>0.794</td><td>0.94 MPa<sup>0.5</sup></td></tr>
                                    <tr><td>Tv</td><td>0.864</td><td>15.1 &deg;C</td></tr>
                                </tbody>
                            </table>
                            <p class="reference">
                                <strong>Data Source:</strong> Niederquell, A., & Kuentz, M. (2018).
                                <a href="https://doi.org/10.17632/b4dmjzk8w6.1" target="_blank">Mendeley Data, V1</a>
                            </p>
                            <p style="margin-top: 1rem;">
                                <a href="/method" target="_blank" class="method-link">
                                    üìÑ View Detailed Method Documentation
                                </a>
                            </p>
                        </div>
                    </details>
                </div>
            </div>
        </section>

        <!-- Data List Section -->
        <section id="data-list" class="content-section">
            <div class="data-list-container">
                <div class="data-list-header">
                    <h2>Data Manager</h2>
                    <div class="header-actions">
                        <button id="import-sets-btn" class="btn btn-secondary">Import Sets</button>
                        <button id="export-sets-btn" class="btn btn-secondary">Export Sets</button>
                    </div>
                </div>

                <!-- Experimental Results Section -->
                <div class="experimental-results-section">
                    <div class="section-header">
                        <h3>Experimental Results</h3>
                        <span id="results-count" class="count-badge">0 results</span>
                    </div>

                    <div id="experimental-results-table"></div>

                    <div id="experimental-results-empty" class="empty-state" style="display: none;">
                        <p>No experimental results saved yet.</p>
                        <p>Run HSP calculations in the HSP Experimental section and save results to manage them here.</p>
                    </div>
                </div>

                <!-- User Solvents Section -->
                <div class="user-solvents-section">
                    <div class="section-header">
                        <h3>User Solvents</h3>
                        <div>
                            <button id="add-user-solvent-btn" class="btn btn-primary btn-small">+ Add Solvent</button>
                            <span id="user-solvents-count" class="count-badge">0 solvents</span>
                        </div>
                    </div>

                    <div id="user-solvents-empty" class="empty-state" style="display: none;">
                        <p>No user solvents yet.</p>
                        <p>Click "+ Add Solvent" above to add your first solvent.</p>
                    </div>

                    <div id="user-solvents-table-container" class="table-container">
                        <div id="user-solvents-table"></div>
                    </div>
                </div>

                <!-- User Polymers Section -->
                <div class="user-polymers-section">
                    <div class="section-header">
                        <h3>User Polymers</h3>
                        <div>
                            <button id="add-user-polymer-btn" class="btn btn-primary btn-small">+ Add Polymer</button>
                            <span id="user-polymers-count" class="count-badge">0 polymers</span>
                        </div>
                    </div>

                    <div id="user-polymers-empty" class="empty-state" style="display: none;">
                        <p>No user polymers yet.</p>
                        <p>Click "+ Add Polymer" above to add your first polymer.</p>
                    </div>

                    <div id="user-polymers-table-container" class="table-container">
                        <div id="user-polymers-table"></div>
                    </div>
                </div>

                <!-- Saved Mixtures Section -->
                <div class="saved-mixtures-section">
                    <div class="section-header">
                        <h3>Saved Mixtures</h3>
                        <span id="saved-mixtures-count" class="count-badge">0 mixtures</span>
                    </div>

                    <div id="saved-mixtures-empty" class="empty-state" style="display: none;">
                        <p>No saved mixtures yet.</p>
                        <p>Create mixtures in the Calculate HSP tab to manage them here.</p>
                    </div>

                    <div id="saved-mixtures-table-container" class="table-container">
                        <div id="saved-mixtures-table"></div>
                    </div>
                </div>

                <!-- Saved Solvent Sets Section -->
                <div class="solvent-sets-section">
                    <div class="section-header">
                        <h3>Saved Solvent Sets</h3>
                        <span id="sets-count" class="count-badge">0 sets</span>
                    </div>

                    <div id="solvent-sets-list" class="solvent-sets-list">
                        <div class="empty-state">
                            <p>No solvent sets saved yet.</p>
                            <p>Create sets in the Determine HSP tab to manage them here.</p>
                        </div>
                    </div>
                </div>

                <!-- Polymer Database Section (Collapsible) -->
                <div class="polymer-database-section collapsible-section">
                    <div class="section-header collapsible-header">
                        <h3>
                            <button id="polymer-database-collapse-toggle" class="collapse-toggle" aria-expanded="false">
                                <span class="collapse-icon">‚ñ∂</span>
                                <span class="collapse-text">Polymer Database</span>
                            </button>
                        </h3>
                        <span id="polymer-database-count" class="count-badge">0 polymers</span>
                    </div>

                    <div id="polymer-database-collapsible-content" class="collapsible-content" style="display: none;">
                        <div id="polymer-database-table-container" class="table-container">
                            <div id="polymer-database-table"></div>
                        </div>
                    </div>
                </div>

                <!-- Solvent Database Section (Collapsible) -->
                <div class="solvent-database-section collapsible-section">
                    <div class="section-header collapsible-header">
                        <h3>
                            <button id="database-collapse-toggle" class="collapse-toggle" aria-expanded="false">
                                <span class="collapse-icon">‚ñ∂</span>
                                <span class="collapse-text">Solvent Database</span>
                            </button>
                        </h3>
                        <span id="database-count" class="count-badge">0 solvents</span>
                    </div>

                    <div id="database-collapsible-content" class="collapsible-content" style="display: none;">
                        <div id="solvent-database-table-container" class="table-container">
                            <div id="solvent-database-table"></div>
                        </div>
                    </div>
                </div>

                <!-- Edit Modal -->
                <div id="edit-set-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Solvent Set</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="edit-set-name">Set Name:</label>
                                <input type="text" id="edit-set-name" class="form-input" placeholder="Enter set name">
                            </div>

                            <div class="form-group">
                                <label>Solvents in this set:</label>
                                <div id="edit-solvents-list" class="edit-solvents-list">
                                    <!-- Solvent list will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="save-set-changes" class="btn btn-primary">Save Changes</button>
                            <button id="cancel-set-edit" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Add User Solvent Modal -->
                <div id="add-user-solvent-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Add New Solvent</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="add-solvent-name">Solvent Name: *</label>
                                <input type="text" id="add-solvent-name" class="form-input" placeholder="Enter solvent name" required>
                            </div>
                            <div class="hsp-input-row">
                                <div class="form-group">
                                    <label for="add-delta-d">Œ¥D (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="add-delta-d" class="form-input" step="0.1" placeholder="15.5" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-delta-p">Œ¥P (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="add-delta-p" class="form-input" step="0.1" placeholder="7.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-delta-h">Œ¥H (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="add-delta-h" class="form-input" step="0.1" placeholder="8.0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="add-cas">CAS Number:</label>
                                <input type="text" id="add-cas" class="form-input" placeholder="67-56-1">
                            </div>
                            <div class="form-group">
                                <label for="add-boiling-point">Boiling Point (¬∞C):</label>
                                <input type="number" id="add-boiling-point" class="form-input" step="0.1" placeholder="64.7">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="save-add-user-solvent-btn" class="btn btn-primary">Add Solvent</button>
                            <button id="cancel-add-user-solvent-btn" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Edit User Solvent Modal -->
                <div id="edit-user-solvent-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit User Solvent</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="edit-solvent-name">Solvent Name: *</label>
                                <input type="text" id="edit-solvent-name" class="form-input" placeholder="Enter solvent name" required>
                            </div>
                            <div class="hsp-input-row">
                                <div class="form-group">
                                    <label for="edit-delta-d">Œ¥D (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="edit-delta-d" class="form-input" step="0.1" placeholder="15.5" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-delta-p">Œ¥P (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="edit-delta-p" class="form-input" step="0.1" placeholder="7.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-delta-h">Œ¥H (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="edit-delta-h" class="form-input" step="0.1" placeholder="8.0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="edit-cas">CAS Number:</label>
                                <input type="text" id="edit-cas" class="form-input" placeholder="67-56-1">
                            </div>
                            <div class="form-group">
                                <label for="edit-boiling-point">Boiling Point (¬∞C):</label>
                                <input type="number" id="edit-boiling-point" class="form-input" step="0.1" placeholder="64.7">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="save-user-solvent-btn" class="btn btn-primary">Save Changes</button>
                            <button id="cancel-edit-user-solvent-btn" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Add User Polymer Modal -->
                <div id="add-user-polymer-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Add New Polymer</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="add-polymer-name">Polymer Name: *</label>
                                <input type="text" id="add-polymer-name" class="form-input" placeholder="Enter polymer name" required>
                            </div>
                            <div class="hsp-input-row">
                                <div class="form-group">
                                    <label for="add-polymer-delta-d">Œ¥D (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="add-polymer-delta-d" class="form-input" step="0.1" placeholder="18.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-polymer-delta-p">Œ¥P (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="add-polymer-delta-p" class="form-input" step="0.1" placeholder="6.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-polymer-delta-h">Œ¥H (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="add-polymer-delta-h" class="form-input" step="0.1" placeholder="4.0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="add-polymer-r0">R0 (MPa<sup>0.5</sup>): *</label>
                                <input type="number" id="add-polymer-r0" class="form-input" step="0.1" placeholder="8.0" required>
                            </div>
                            <div class="form-group">
                                <label for="add-polymer-cas">CAS Number:</label>
                                <input type="text" id="add-polymer-cas" class="form-input" placeholder="9003-07-0">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="save-add-user-polymer-btn" class="btn btn-primary">Add Polymer</button>
                            <button id="cancel-add-user-polymer-btn" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Edit User Polymer Modal -->
                <div id="edit-user-polymer-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit User Polymer</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="edit-polymer-name">Polymer Name: *</label>
                                <input type="text" id="edit-polymer-name" class="form-input" placeholder="Enter polymer name" required>
                            </div>
                            <div class="hsp-input-row">
                                <div class="form-group">
                                    <label for="edit-polymer-delta-d">Œ¥D (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="edit-polymer-delta-d" class="form-input" step="0.1" placeholder="18.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-polymer-delta-p">Œ¥P (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="edit-polymer-delta-p" class="form-input" step="0.1" placeholder="6.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-polymer-delta-h">Œ¥H (MPa<sup>0.5</sup>): *</label>
                                    <input type="number" id="edit-polymer-delta-h" class="form-input" step="0.1" placeholder="4.0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="edit-polymer-r0">R0 (MPa<sup>0.5</sup>): *</label>
                                <input type="number" id="edit-polymer-r0" class="form-input" step="0.1" placeholder="8.0" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-polymer-cas">CAS Number:</label>
                                <input type="text" id="edit-polymer-cas" class="form-input" placeholder="9003-07-0">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="save-user-polymer-btn" class="btn btn-primary">Save Changes</button>
                            <button id="cancel-edit-user-polymer-btn" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Import File Input -->
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>
        </section>

        <!-- Calculation Settings Modal -->
        <div id="calculation-settings-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>Calculation Settings</h2>
                    <button class="modal-close" onclick="document.getElementById('calculation-settings-modal').style.display='none'">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="loss-function-select">Loss Function:</label>
                        <select id="loss-function-select" class="form-control">
                            <option value="optimize_radius_only" selected>Cross Entropy ‚Üí Optimize R0 Only (Recommended)</option>
                            <option value="cross_entropy">Cross Entropy</option>
                            <option value="hspipy_default">HSPiPy Default (Classic DATAFIT)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="size-factor-input">Size Factor (Sphere Radius Penalty):</label>
                        <input type="number" id="size-factor-input" class="form-control"
                               value="0.0" min="0" max="0.01" step="0.0001"
                               placeholder="0.0">
                        <small class="form-text">Penalty for large sphere radius. Default: 0.0 (no penalty). Range: 0.0 - 0.01</small>
                    </div>
                    <div class="form-group" style="margin-top: 20px; padding: 15px; background-color: #f0f0f0; border-radius: 5px;">
                        <details>
                            <summary style="cursor: pointer; font-weight: bold; font-size: 16px; margin-bottom: 10px; user-select: none;">
                                About Loss Functions
                            </summary>
                            <div style="padding-top: 10px;">
                                <!-- Cross Entropy ‚Üí Optimize R0 Only -->
                                <div style="margin-bottom: 25px;">
                                    <h4 style="margin: 0 0 10px 0; color: #2c5282;">
                                        Cross Entropy ‚Üí Optimize R0 Only
                                        <span style="display: inline-block; margin-left: 8px; padding: 2px 6px; background: #48bb78; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">RECOMMENDED</span>
                                    </h4>
                                    <p style="margin: 8px 0; font-size: 14px; line-height: 1.6;">
                                        Two-phase optimization strategy that combines theoretical rigor with practical constraints.
                                    </p>

                                    <h5 style="margin: 12px 0 6px 0; font-size: 13px; color: #4a5568;">Phase 1: Center Calculation (Cross Entropy)</h5>
                                    <p style="margin: 4px 0; font-size: 13px; line-height: 1.5;">
                                        Calculate center (Œ¥D, Œ¥P, Œ¥H) using Cross Entropy loss function:
                                    </p>
                                    <div style="background: white; padding: 10px; border-radius: 4px; margin: 8px 0; font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto;">
                                        L = -Œ£ [y<sub>i</sub> log(p<sub>i</sub>) + (1-y<sub>i</sub>) log(1-p<sub>i</sub>)]
                                    </div>
                                    <p style="margin: 4px 0; font-size: 12px; line-height: 1.4; color: #4a5568;">
                                        where p<sub>i</sub> = œÉ(1 - RED<sub>i</sub>) = 1 / (1 + exp(-(1 - RED<sub>i</sub>)))<br>
                                        RED<sub>i</sub> = distance<sub>i</sub> / R0<sub>trial</sub><br>
                                        distance<sub>i</sub> = ‚àö[4(Œ¥D<sub>i</sub> - Œ¥D)¬≤ + (Œ¥P<sub>i</sub> - Œ¥P)¬≤ + (Œ¥H<sub>i</sub> - Œ¥H)¬≤]
                                    </p>

                                    <h5 style="margin: 12px 0 6px 0; font-size: 13px; color: #4a5568;">Phase 2: Radius Optimization</h5>
                                    <p style="margin: 4px 0; font-size: 13px; line-height: 1.5;">
                                        Fix center from Phase 1, then set radius to minimum sphere covering all soluble points:
                                    </p>
                                    <div style="background: white; padding: 10px; border-radius: 4px; margin: 8px 0; font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto;">
                                        R0 = max{distance<sub>i</sub> | y<sub>i</sub> = 1.0}
                                    </div>
                                    <p style="margin: 4px 0; font-size: 12px; line-height: 1.4; color: #4a5568;">
                                        This ensures all soluble points (y<sub>i</sub> = 1.0) are inside the sphere while minimizing false positives.
                                    </p>

                                    <p style="margin: 10px 0 0 0; font-size: 13px; line-height: 1.5; padding: 8px; background: #e6fffa; border-left: 3px solid #48bb78; border-radius: 3px;">
                                        <strong>Why recommended:</strong> Combines theoretical optimization (Cross Entropy) with practical constraint (minimum sphere), resulting in high accuracy with minimal false positives.
                                    </p>
                                </div>

                                <!-- Cross Entropy -->
                                <div style="margin-bottom: 25px;">
                                    <h4 style="margin: 0 0 10px 0; color: #2c5282;">Cross Entropy</h4>
                                    <p style="margin: 8px 0; font-size: 14px; line-height: 1.6;">
                                        Information-theoretic approach that simultaneously optimizes center and radius.
                                    </p>
                                    <div style="background: white; padding: 10px; border-radius: 4px; margin: 8px 0; font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto;">
                                        L = -Œ£ [y<sub>i</sub> log(p<sub>i</sub>) + (1-y<sub>i</sub>) log(1-p<sub>i</sub>)]
                                    </div>
                                    <p style="margin: 4px 0; font-size: 12px; line-height: 1.4; color: #4a5568;">
                                        where p<sub>i</sub> = œÉ(1 - RED<sub>i</sub>) represents the probability of solubility.<br>
                                        Handles continuous solubility values (0.0 ‚â§ y<sub>i</sub> ‚â§ 1.0) naturally.<br>
                                        Provides theoretical foundation based on maximum likelihood estimation.
                                    </p>
                                </div>

                                <!-- HSPiPy Default -->
                                <div style="margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #2c5782;">HSPiPy Default (Classic DATAFIT)</h4>
                                    <p style="margin: 8px 0; font-size: 14px; line-height: 1.6;">
                                        Industry-standard classic DATAFIT method from Hansen's original work.
                                    </p>
                                    <p style="margin: 4px 0; font-size: 13px; line-height: 1.5;">
                                        Uses distance-based fitting:
                                    </p>
                                    <div style="background: white; padding: 10px; border-radius: 4px; margin: 8px 0; font-family: 'Courier New', monospace; font-size: 13px; overflow-x: auto;">
                                        FIT = N<sub>correct</sub> / N<sub>total</sub>
                                    </div>
                                    <p style="margin: 4px 0; font-size: 12px; line-height: 1.4; color: #4a5568;">
                                        where N<sub>correct</sub> = number of correctly classified solvents<br>
                                        Soluble if RED < 1, Insoluble if RED > 1<br>
                                        Maximizes FIT through iterative sphere adjustment.<br>
                                        Useful for benchmarking against established HSP calculations.
                                    </p>
                                </div>

                                <!-- Hansen Theory -->
                                <div style="margin-top: 20px; padding: 12px; background: #fff; border: 1px solid #cbd5e0; border-radius: 4px;">
                                    <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #2d3748;">Hansen Solubility Theory</h5>
                                    <p style="margin: 0; font-size: 12px; line-height: 1.5; color: #4a5568;">
                                        All methods are based on Hansen solubility parameters (HSP) theory:<br>
                                        <strong>Œ¥D:</strong> Dispersion forces, <strong>Œ¥P:</strong> Polar forces, <strong>Œ¥H:</strong> Hydrogen bonding<br>
                                        <strong>RED</strong> (Relative Energy Difference) = distance / R0 determines solubility:<br>
                                        RED < 1 ‚Üí Soluble, RED > 1 ‚Üí Insoluble, RED ‚âà 1 ‚Üí Boundary
                                    </p>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="document.getElementById('calculation-settings-modal').style.display='none'">Cancel</button>
                    <button id="save-calculation-settings-btn" class="btn btn-primary">Save Settings</button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    <script src="/static/js/utils.js?v=20251114MODAL"></script>
    <script src="/static/js/notification.js"></script>
    <script src="/static/js/storage.js"></script>
    <script src="/static/js/user_solvents.js"></script>
    <script src="/static/js/shared_solvent_cache.js"></script>
    <script src="/static/js/solvent_table.js?v=20251115VALIDATION"></script>
    <script src="/static/js/main.js?v=20251122HOME"></script>
    <script src="/static/js/solvent_set_manager.js?v=20251116CALC"></script>
    <script src="/static/js/experimental_results_manager.js"></script>
    <script src="/static/js/hsp_visualization.js?v=20251115TARGET3H"></script>
    <script src="/static/js/hsp_experimental.js?v=20251108MANUAL"></script>
    <script src="/static/js/hsp_calculation.js?v=20251115VALIDATION"></script>
    <script src="/static/js/solvent_search.js?v=20251122UI2"></script>
    <script src="/static/js/data_list.js?v=20251114MODAL"></script>
    <script src="/static/js/smiles_predict.js?v=20251122"></script>
</body>
</html>
